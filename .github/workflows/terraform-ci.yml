name: Terraform CI

on:
  pull_request:
    paths:
      - 'architectures/**'
      - '.github/workflows/terraform-*.yml'
  push:
    branches:
      - main
    paths:
      - 'architectures/**'
      - '.github/workflows/terraform-*.yml'

permissions:
  contents: read
  pull-requests: write

env:
  TF_VERSION: '1.13.0'

jobs:
  detect-changes:
    name: Detect Changed Patterns
    runs-on: ubuntu-latest
    outputs:
      architectures: ${{ steps.detect.outputs.architectures }}
      has_changes: ${{ steps.detect.outputs.has_changes }}
      all_patterns: ${{ steps.detect.outputs.all_patterns }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed architectures
        id: detect
        run: |
          # Get all patterns
          ALL_PATTERNS=$(find architectures -maxdepth 1 -mindepth 1 -type d -exec basename {} \; | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "all_patterns=$ALL_PATTERNS" >> $GITHUB_OUTPUT

          # Get changed files
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Check if workflow files were changed
          WORKFLOW_CHANGED=$(echo "$CHANGED_FILES" | grep '^.github/workflows/' || true)

          if [ -n "$WORKFLOW_CHANGED" ]; then
            echo "Workflow files changed - testing all architectures"
            echo "architectures=$ALL_PATTERNS" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Detected patterns: $ALL_PATTERNS (all - workflow changed)"
          else
            # Only check changed architectures
            PATTERNS=$(echo "$CHANGED_FILES" | \
              grep '^architectures/' | \
              cut -d'/' -f2 | \
              sort -u | \
              jq -R -s -c 'split("\n") | map(select(length > 0))')

            echo "architectures=$PATTERNS" >> $GITHUB_OUTPUT

            if [ "$PATTERNS" != "[]" ] && [ -n "$PATTERNS" ]; then
              echo "has_changes=true" >> $GITHUB_OUTPUT
              echo "Detected patterns: $PATTERNS"
            else
              echo "has_changes=false" >> $GITHUB_OUTPUT
              echo "No pattern changes detected"
            fi
          fi

  terraform-format:
    name: Format Check - ${{ matrix.pattern }}
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      matrix:
        pattern: ${{ fromJson(needs.detect-changes.outputs.architectures) }}
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        id: fmt
        run: |
          echo "Checking format for pattern: ${{ matrix.pattern }}"
          cd architectures/${{ matrix.pattern }}/gcp
          terraform fmt -check -recursive -diff

      - name: Upload format issues
        if: failure()
        run: |
          echo "::error::Format check failed for ${{ matrix.pattern }}"
          echo "Run 'terraform fmt -recursive' to fix formatting issues"

  terraform-validate:
    name: Validate - ${{ matrix.pattern }}/${{ matrix.environment }}
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      matrix:
        pattern: ${{ fromJson(needs.detect-changes.outputs.architectures) }}
        environment: [dev, prod]
      fail-fast: false
    defaults:
      run:
        working-directory: architectures/${{ matrix.pattern }}/gcp/environments/${{ matrix.environment }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init (backend=false)
        run: terraform init -backend=false

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color

  tflint:
    name: TFLint - ${{ matrix.pattern }}
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      matrix:
        pattern: ${{ fromJson(needs.detect-changes.outputs.architectures) }}
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest

      - name: Init TFLint
        run: |
          cd architectures/${{ matrix.pattern }}/gcp
          tflint --init

      - name: Run TFLint on modules
        run: |
          cd architectures/${{ matrix.pattern }}/gcp/modules
          for module in */; do
            echo "Linting module: ${module}"
            cd "$module"
            tflint --format compact || true
            cd ..
          done

      - name: Run TFLint on environments
        run: |
          cd architectures/${{ matrix.pattern }}/gcp/environments
          for env in */; do
            echo "Linting environment: ${env}"
            cd "$env"
            tflint --format compact || true
            cd ..
          done

  terraform-docs:
    name: Docs Check - ${{ matrix.pattern }}
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      matrix:
        pattern: ${{ fromJson(needs.detect-changes.outputs.architectures) }}
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check README exists
        run: |
          if [ ! -f "architectures/${{ matrix.pattern }}/gcp/README.md" ]; then
            echo "::warning::README.md not found for ${{ matrix.pattern }}"
          else
            echo "✓ README.md exists"
          fi

      - name: Check module documentation
        run: |
          MODULE_PATH="architectures/${{ matrix.pattern }}/gcp/modules"
          if [ -d "$MODULE_PATH" ]; then
            for module in "$MODULE_PATH"/*; do
              if [ -d "$module" ]; then
                module_name=$(basename "$module")
                # Check for variables.tf
                if [ ! -f "$module/variables.tf" ]; then
                  echo "::warning::variables.tf not found in module $module_name"
                fi
                # Check for outputs.tf
                if [ ! -f "$module/outputs.tf" ]; then
                  echo "::warning::outputs.tf not found in module $module_name"
                fi
              fi
            done
          fi

  security-scan:
    name: Security Scan - ${{ matrix.pattern }}
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      matrix:
        pattern: ${{ fromJson(needs.detect-changes.outputs.architectures) }}
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Trivy security scanner
        uses: aquasecurity/trivy-action@0.29.0
        with:
          scan-type: 'config'
          scan-ref: 'architectures/${{ matrix.pattern }}/gcp'
          format: 'table'
          exit-code: '0'

  test-terraform-syntax:
    name: Syntax Test - ${{ matrix.pattern }}
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      matrix:
        pattern: ${{ fromJson(needs.detect-changes.outputs.architectures) }}
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Test module syntax
        run: |
          cd architectures/${{ matrix.pattern }}/gcp/modules
          for module in */; do
            echo "Testing syntax for module: ${module}"
            cd "$module"
            terraform init -backend=false
            terraform validate
            cd ..
          done

  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs:
      - detect-changes
      - terraform-format
      - terraform-validate
      - tflint
      - terraform-docs
      - security-scan
      - test-terraform-syntax
    if: always()
    steps:
      - name: Check results
        run: |
          echo "## Terraform CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Patterns tested:** ${{ needs.detect-changes.outputs.architectures }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Format | ${{ needs.terraform-format.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Validate | ${{ needs.terraform-validate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TFLint | ${{ needs.tflint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Documentation | ${{ needs.terraform-docs.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Syntax Test | ${{ needs.test-terraform-syntax.result }} |" >> $GITHUB_STEP_SUMMARY

          # Fail if any required check failed
          if [ "${{ needs.terraform-format.result }}" == "failure" ] || \
             [ "${{ needs.terraform-validate.result }}" == "failure" ] || \
             [ "${{ needs.test-terraform-syntax.result }}" == "failure" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "❌ **CI checks failed**" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ **All CI checks passed**" >> $GITHUB_STEP_SUMMARY
          fi
