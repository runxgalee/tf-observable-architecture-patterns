name: Terraform CI

on:
  pull_request:
    paths:
      - 'architectures/**'
      - '.github/workflows/terraform-*.yml'
  push:
    branches:
      - main
    paths:
      - 'architectures/**'
      - '.github/workflows/terraform-*.yml'

permissions:
  contents: read
  pull-requests: write

env:
  TF_VERSION: '1.13.0'

jobs:
  get-patterns:
    name: Get Architecture Patterns
    uses: ./.github/workflows/_patterns-config.yml

  terraform-format:
    name: Format Check - ${{ matrix.pattern }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: get-patterns
    strategy:
      matrix:
        pattern: ${{ fromJson(needs.get-patterns.outputs.all_patterns) }}
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        id: fmt
        run: |
          echo "Checking format for pattern: ${{ matrix.pattern }}"
          cd architectures/${{ matrix.pattern }}/gcp
          terraform fmt -check -recursive -diff

      - name: Upload format issues
        if: failure()
        run: |
          echo "::error::Format check failed for ${{ matrix.pattern }}"
          echo "Run 'terraform fmt -recursive' to fix formatting issues"

  terraform-validate:
    name: Validate - ${{ matrix.pattern }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: get-patterns
    strategy:
      matrix:
        pattern: ${{ fromJson(needs.get-patterns.outputs.all_patterns) }}
      fail-fast: false
    defaults:
      run:
        working-directory: architectures/${{ matrix.pattern }}/gcp

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache Terraform providers
        uses: actions/cache@v4
        with:
          path: ~/.terraform.d/plugin-cache
          key: ${{ runner.os }}-terraform-${{ hashFiles('**/.terraform.lock.hcl') }}
          restore-keys: |
            ${{ runner.os }}-terraform-

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init (backend=false)
        run: terraform init -backend=false
        env:
          TF_PLUGIN_CACHE_DIR: ~/.terraform.d/plugin-cache

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color

  tflint:
    name: TFLint - ${{ matrix.pattern }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: get-patterns
    strategy:
      matrix:
        pattern: ${{ fromJson(needs.get-patterns.outputs.all_patterns) }}
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache TFLint plugins
        uses: actions/cache@v4
        with:
          path: ~/.tflint.d/plugins
          key: ${{ runner.os }}-tflint-${{ hashFiles('**/.tflint.hcl') }}
          restore-keys: |
            ${{ runner.os }}-tflint-

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: v0.54.0

      - name: Init TFLint
        run: |
          cd architectures/${{ matrix.pattern }}/gcp
          tflint --init

      - name: Run TFLint on modules
        id: tflint-modules
        continue-on-error: true
        run: |
          cd architectures/${{ matrix.pattern }}/gcp/modules
          ERROR_COUNT=0
          for module in */; do
            echo "Linting module: ${module}"
            cd "$module"
            if ! tflint --format compact; then
              ERROR_COUNT=$((ERROR_COUNT + 1))
            fi
            cd ..
          done
          if [ $ERROR_COUNT -gt 0 ]; then
            echo "::warning::TFLint found issues in $ERROR_COUNT module(s)"
            exit 1
          fi

      - name: Run TFLint on root
        id: tflint-root
        continue-on-error: true
        run: |
          cd architectures/${{ matrix.pattern }}/gcp
          if ! tflint --format compact; then
            echo "::warning::TFLint found issues in root configuration"
            exit 1
          fi

  terraform-docs:
    name: Docs Check - ${{ matrix.pattern }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: get-patterns
    strategy:
      matrix:
        pattern: ${{ fromJson(needs.get-patterns.outputs.all_patterns) }}
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check README exists
        run: |
          if [ ! -f "architectures/${{ matrix.pattern }}/gcp/README.md" ]; then
            echo "::warning::README.md not found for ${{ matrix.pattern }}"
          else
            echo "✓ README.md exists"
          fi

      - name: Check module documentation
        run: |
          MODULE_PATH="architectures/${{ matrix.pattern }}/gcp/modules"
          if [ -d "$MODULE_PATH" ]; then
            for module in "$MODULE_PATH"/*; do
              if [ -d "$module" ]; then
                module_name=$(basename "$module")
                # Check for variables.tf
                if [ ! -f "$module/variables.tf" ]; then
                  echo "::warning::variables.tf not found in module $module_name"
                fi
                # Check for outputs.tf
                if [ ! -f "$module/outputs.tf" ]; then
                  echo "::warning::outputs.tf not found in module $module_name"
                fi
              fi
            done
          fi

  security-scan:
    name: Security Scan - ${{ matrix.pattern }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: get-patterns
    strategy:
      matrix:
        pattern: ${{ fromJson(needs.get-patterns.outputs.all_patterns) }}
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Trivy security scanner
        uses: aquasecurity/trivy-action@0.29.0
        continue-on-error: true
        with:
          scan-type: 'config'
          scan-ref: 'architectures/${{ matrix.pattern }}/gcp'
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'

  terraform-test:
    name: Terraform Test - ${{ matrix.pattern }}
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: get-patterns
    strategy:
      matrix:
        pattern: ${{ fromJson(needs.get-patterns.outputs.all_patterns) }}
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache Terraform providers
        uses: actions/cache@v4
        with:
          path: ~/.terraform.d/plugin-cache
          key: ${{ runner.os }}-terraform-${{ hashFiles('**/.terraform.lock.hcl') }}
          restore-keys: |
            ${{ runner.os }}-terraform-

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Check for test files
        id: check-tests
        run: |
          TEST_DIR="architectures/${{ matrix.pattern }}/gcp/tests"
          if [ -d "$TEST_DIR" ] && [ "$(ls -A $TEST_DIR/*.tftest.hcl 2>/dev/null)" ]; then
            echo "has_tests=true" >> $GITHUB_OUTPUT
            echo "Found test files in $TEST_DIR"
          else
            echo "has_tests=false" >> $GITHUB_OUTPUT
            echo "No test files found in $TEST_DIR"
          fi

      - name: Terraform Init
        if: steps.check-tests.outputs.has_tests == 'true'
        run: |
          cd architectures/${{ matrix.pattern }}/gcp
          terraform init -backend=false
        env:
          TF_PLUGIN_CACHE_DIR: ~/.terraform.d/plugin-cache

      - name: Run Terraform Tests
        if: steps.check-tests.outputs.has_tests == 'true'
        run: |
          cd architectures/${{ matrix.pattern }}/gcp
          terraform test -test-directory=tests

  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs:
      - get-patterns
      - terraform-format
      - terraform-validate
      - tflint
      - terraform-docs
      - security-scan
      - terraform-test
    if: always()
    steps:
      - name: Check results
        run: |
          echo "## Terraform CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Patterns tested:** ${{ needs.get-patterns.outputs.all_patterns_list }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Format | ${{ needs.terraform-format.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Validate | ${{ needs.terraform-validate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TFLint | ${{ needs.tflint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Documentation | ${{ needs.terraform-docs.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform Test | ${{ needs.terraform-test.result }} |" >> $GITHUB_STEP_SUMMARY

          # Fail if any required check failed
          if [ "${{ needs.terraform-format.result }}" == "failure" ] || \
             [ "${{ needs.terraform-validate.result }}" == "failure" ] || \
             [ "${{ needs.terraform-test.result }}" == "failure" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "❌ **CI checks failed**" >> $GITHUB_STEP_SUMMARY
            exit 1
          elif [ "${{ needs.tflint.result }}" == "failure" ] || \
               [ "${{ needs.security-scan.result }}" == "failure" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "⚠️ **CI checks passed with warnings (TFLint or Security Scan issues)**" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ **All CI checks passed**" >> $GITHUB_STEP_SUMMARY
          fi
