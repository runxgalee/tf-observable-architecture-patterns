name: Terraform Apply on Main

on:
  workflow_run:
    workflows: ["Terraform CI"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:
    inputs:
      architecture:
        description: 'Architecture to apply'
        required: true
        type: choice
        options:
          - event-driven
      environment:
        description: 'Environment to apply'
        required: true
        type: choice
        options:
          - dev
          - prod
        default: dev

permissions:
  contents: read
  id-token: write
  pull-requests: write

env:
  TF_VERSION: '1.13.0'

jobs:
  check-ci-result:
    name: Check CI Result
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Check CI workflow result
        id: check
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "Manual trigger - proceeding with apply"
            echo "should_run=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.workflow_run.conclusion }}" == "success" ]; then
            echo "CI workflow succeeded - proceeding with apply"
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "CI workflow did not succeed - skipping apply"
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  get-patterns:
    name: Get Architecture Patterns
    needs: check-ci-result
    if: needs.check-ci-result.outputs.should_run == 'true'
    uses: ./.github/workflows/_patterns-config.yml

